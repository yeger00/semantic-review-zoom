{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/yeger00/semantic-review-zoom/schema/semantic-review.schema.json",
  "title": "SemanticReview",
  "description": "Semantic zoom review of a pull request. Nodes form a tree via parent IDs; the number and meaning of layers is project-defined.",
  "type": "object",
  "required": ["version", "generated_at", "pr", "layers", "nodes"],
  "properties": {
    "version": { "type": "string", "enum": ["2.0"] },
    "generated_at": { "type": "string", "format": "date-time" },
    "pr": {
      "type": "object",
      "required": ["number", "title", "url", "base", "head"],
      "properties": {
        "number": { "type": "integer", "minimum": 1 },
        "title":  { "type": "string" },
        "url":    { "type": "string", "format": "uri" },
        "base":   { "type": "string" },
        "head":   { "type": "string" }
      },
      "additionalProperties": false
    },
    "layers": {
      "description": "Ordered layer definitions from coarsest to finest. Project-defined; any number â‰¥ 1.",
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "title"],
        "properties": {
          "id":          { "type": "string" },
          "title":       { "type": "string" },
          "description": { "type": "string" }
        },
        "additionalProperties": false
      }
    },
    "nodes": {
      "description": "Flat list of all review nodes. Each node belongs to a layer and optionally has a parent node in the layer above it.",
      "type": "array",
      "items": { "$ref": "#/definitions/ReviewNode" }
    }
  },
  "additionalProperties": false,
  "definitions": {
    "ReviewNode": {
      "type": "object",
      "required": ["id", "layer", "parent", "title", "summary", "change_type", "meta"],
      "properties": {
        "id":          { "type": "string", "description": "Unique node identifier" },
        "layer":       { "type": "string", "description": "Layer ID this node belongs to (must match a layers[].id)" },
        "parent":      { "type": ["string", "null"], "description": "ID of parent node, or null for root-level nodes" },
        "title":       { "type": "string", "description": "Short display name" },
        "summary":     { "type": ["string", "null"], "description": "One-sentence description of the change" },
        "change_type": { "type": ["string", "null"], "enum": ["added", "modified", "deleted", null] },
        "meta": {
          "type": "object",
          "description": "Layer-specific metadata. Well-known shapes: group meta (files_changed, insertions, deletions, change_pct), symbol meta (kind, file, signature_before, signature_after), diff meta (file, hunks[]).",
          "properties": {
            "files_changed":     { "type": "integer" },
            "insertions":        { "type": "integer" },
            "deletions":         { "type": "integer" },
            "change_pct":        { "type": "number", "minimum": 0, "maximum": 100 },
            "kind":              { "type": "string" },
            "file":              { "type": "string" },
            "signature_before":  { "type": ["string", "null"] },
            "signature_after":   { "type": ["string", "null"] },
            "hunks": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["header", "is_formatting_only", "lines"],
                "properties": {
                  "header":             { "type": "string" },
                  "is_formatting_only": { "type": "boolean" },
                  "lines": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["type", "content"],
                      "properties": {
                        "type":    { "type": "string", "enum": ["insert", "delete", "context"] },
                        "content": { "type": "string" }
                      },
                      "additionalProperties": false
                    }
                  }
                },
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    }
  }
}

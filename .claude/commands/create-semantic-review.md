# create-semantic-review

Generate a semantic zoom review and save it as a `.md` file. Usage: `/create-semantic-review <PR-number-or-URL>`

## Instructions

You are generating a structured semantic zoom review (v2.0) for a pull request and saving it as a markdown file that can be loaded into the semantic-review-zoom web app. The JSON contains a flat list of nodes forming a zoom tree — root nodes at the top, diff nodes at the leaves.

### Step 1: Parse Arguments

Extract the PR number or URL from `$ARGUMENTS`.
- If it's a URL like `https://github.com/owner/repo/pull/42`, extract the number `42`
- If it's just a number like `42`, use it directly
- If no argument is provided, ask: "Please provide a PR number or URL, e.g. /create-semantic-review 42"

### Step 2: Verify Setup

Check that `.semantic-pr-zoom.json` exists:
```bash
test -f .semantic-pr-zoom.json || echo "ERROR: Run /init-semantic-review first"
```

Check that the build_layers script exists:
```bash
test -f scripts/semantic-review/build_layers.sh || echo "ERROR: Run /init-semantic-review first"
```

If either check fails, stop and instruct the user to run `/init-semantic-review` first.

### Step 3: Fetch PR Metadata

```bash
gh pr view <PR> --json number,title,url,baseRefName,headRefName > /tmp/spz-pr.json
```

Show the PR title so the user knows which PR is being processed.

### Step 4: Fetch PR Diff

```bash
gh pr diff <PR> > /tmp/spz-diff.patch
```

Check that the diff is not empty. If empty, warn the user that the PR has no changes.

### Step 5: Run Semantic Analysis

```bash
bash scripts/semantic-review/build_layers.sh \
  --diff-file /tmp/spz-diff.patch \
  --pr-json /tmp/spz-pr.json \
  --output /tmp/spz-review.json
```

If the script fails, show the full error output and stop.

Verify the output is valid JSON:
```bash
python3 -c "import json; json.load(open('/tmp/spz-review.json'))" && echo "JSON valid" || echo "JSON invalid"
```

### Step 6: Save Output Files

Copy the raw JSON as `semantic-review-<PR>.json` in the project root:
```bash
cp /tmp/spz-review.json semantic-review-<PR>.json
```

Also write a human-readable markdown wrapper `semantic-review-<PR>.md`:
```markdown
# Semantic Review: PR #<N> — <title>

> Generated by [semantic-pr-zoom](https://github.com/yeger00/semantic-review-zoom).
> Open the `.json` or this `.md` file in the [web app](https://yeger00.github.io/semantic-review-zoom/).

<!-- semantic-pr-zoom -->
```json
<contents of /tmp/spz-review.json>
```
<!-- /semantic-pr-zoom -->
```

Both files work with the web app. The `.json` file is the raw review; the `.md` wraps it with context.

### Step 7: Print Confirmation

Parse `/tmp/spz-review.json` to count nodes per layer and print:

```
✅ Semantic review saved!

PR:    #42 — <title>
Files: semantic-review-42.json  (and .md)

Graph layers:
  <layer-1-title>: <N> nodes  (<M> changed)
  <layer-2-title>: <N> nodes  (<M> changed)
  ...

To view: open https://yeger00.github.io/semantic-review-zoom/
then drop semantic-review-42.json
```

Count nodes per layer with:
```bash
python3 - <<'EOF'
import json
data = json.load(open('/tmp/spz-review.json'))
layers = {l['id']: l['title'] for l in data['layers']}
from collections import defaultdict
counts = defaultdict(lambda: [0, 0])  # [total, changed]
for n in data['nodes']:
    counts[n['layer']][0] += 1
    if n.get('change_type'):
        counts[n['layer']][1] += 1
for lid, title in layers.items():
    total, changed = counts[lid]
    print(f"  {title}: {total} nodes  ({changed} changed)")
EOF
```

### Step 8: Cleanup

```bash
rm -f /tmp/spz-pr.json /tmp/spz-diff.patch /tmp/spz-review.json
```

The output files (`semantic-review-<PR>.json` and `semantic-review-<PR>.md`) remain in the project root for the user to load.

## Error Handling

- If `gh` CLI is not authenticated: run `gh auth login` and retry
- If the PR number doesn't exist: show gh's error message
- If `build_layers.sh` fails: show the full error, suggest running `/init-semantic-review` again

# create-semantic-review

Generate a semantic PR review and save it as a `.md` file. Usage: `/create-semantic-review <PR-number-or-URL>`

## Instructions

You are generating a structured semantic review for a pull request and saving it as a markdown file that can be loaded into the semantic-pr-zoom web app.

### Step 1: Parse Arguments

Extract the PR number or URL from `$ARGUMENTS`.
- If it's a URL like `https://github.com/owner/repo/pull/42`, extract the number `42`
- If it's just a number like `42`, use it directly
- If no argument is provided, ask: "Please provide a PR number or URL, e.g. /create-semantic-review 42"

### Step 2: Verify Setup

Check that `.semantic-pr-zoom.json` exists:
```bash
test -f .semantic-pr-zoom.json || echo "ERROR: Run /init-semantic-review first"
```

Check that the build_layers script exists:
```bash
test -f scripts/semantic-review/build_layers.sh || echo "ERROR: Run /init-semantic-review first"
```

If either check fails, stop and instruct the user to run `/init-semantic-review` first.

### Step 3: Fetch PR Metadata

```bash
gh pr view <PR> --json number,title,url,baseRefName,headRefName > /tmp/spz-pr.json
```

Show the PR title so the user knows which PR is being processed.

### Step 4: Fetch PR Diff

```bash
gh pr diff <PR> > /tmp/spz-diff.patch
```

Check that the diff is not empty. If empty, warn the user that the PR has no changes.

### Step 5: Run Semantic Analysis

```bash
bash scripts/semantic-review/build_layers.sh \
  --diff-file /tmp/spz-diff.patch \
  --pr-json /tmp/spz-pr.json \
  --output /tmp/spz-review.json
```

If the script fails, show the full error output and stop.

Verify the output is valid JSON:
```bash
python3 -c "import json; json.load(open('/tmp/spz-review.json'))" && echo "JSON valid" || echo "JSON invalid"
```

### Step 6: Save as Markdown File

Read `/tmp/spz-review.json` and write a markdown file named `semantic-review-<PR>.md` in the project root with this exact format:

```markdown
# Semantic Review: PR #<N> â€” <title>

> Generated by [semantic-pr-zoom](https://github.com/yeger00/semantic-review-zoom).
> Open this file in the [web app](https://yeger00.github.io/semantic-review-zoom/) to browse the review.

<!-- semantic-pr-zoom -->
```json
<contents of /tmp/spz-review.json>
```
<!-- /semantic-pr-zoom -->
```

The markers and code fence must be preserved exactly â€” the web app uses them to find and parse the JSON.

### Step 7: Print Confirmation

Parse the layer counts from `/tmp/spz-review.json` and print:

```
âœ… Semantic review saved!

PR:   #42 â€” <title>
File: semantic-review-42.md

Layers:
  ðŸ“¦ Packages: <N> packages
  ðŸ”¤ Symbols:  <N> symbols
  ðŸ“„ Diffs:    <N> files

To view: open https://yeger00.github.io/semantic-review-zoom/
then paste or upload semantic-review-42.md
```

### Step 8: Cleanup

```bash
rm -f /tmp/spz-pr.json /tmp/spz-diff.patch /tmp/spz-review.json
```

## Error Handling

- If `gh` CLI is not authenticated: run `gh auth login` and retry
- If the PR number doesn't exist: show gh's error message
- If `build_layers.sh` fails: show the full error, suggest running `/init-semantic-review` again
